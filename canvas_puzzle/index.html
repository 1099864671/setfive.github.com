<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title></title>

    <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,700,800' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Lato:400,700,900' rel='stylesheet' type='text/css'>
    
    <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet">
        
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="bootstrap/js/bootstrap.min.js"></script>
    <script src="lodash.min.js"></script>    
    <script src="fabric.min.js"></script>
    
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    
    <style>
      * { 
        margin:0; 
        padding:0; 
      }
      
      html, body {
       width:100%; 
       height:100%; 
      }
      
      canvas { 
        display:block; 
      }
      
      .main-container {
      	padding: 20px;
      	background: #000;
      	display: none;     	
      }            
                  
      #shuffle {
      	position: absolute;
      	top: 0px;
      	right: 0px;
      }
    </style>    
  </head>
  <body>
  	
  	<div class="main-container">
  		<canvas id="canvas"></canvas>
  	</div>
  	
  	<div class="container main-container">
  		<div class="col-md-12">
  			
  			<button class="btn btn-primary" id="shuffle">Shuffle</button>  			  			
  	      			
		</div>  	       
    </div>    
    
    <canvas style="margin-top: 40px; margin-bottom: 40px;" id="clippingCanvas"></canvas>
    
    <script type="text/javascript">    
      var piece1 = new Image();
      piece1.src = "piece1.png";

      var piece2 = new Image();
      piece2.src = "piece2.png";
      
      var fc = new fabric.Canvas("canvas", {backgroundColor: 'rgb(0, 0, 0)'});
      
      fc.on("object:moving", function(el){
    	 var tl = Math.pow(el.target.getLeft() - el.target.originalCoords[0], 2);    	 
    	 var tt = Math.pow((el.target.getTop() - el.target.originalCoords[1]), 2);    	 
    	 
    	 if( Math.sqrt(tl + tt) < 10 ){
    		 el.target.set("left", el.target.originalCoords[0]);
    		 el.target.set("top", el.target.originalCoords[1]);    		 
    		 el.target.set("lockMovementX", true);
    		 el.target.set("lockMovementY", true);
    		 el.target.set("opacity", .6);
    	 }
      });
      
      fc.setWidth( window.innerWidth - 40 );
      fc.setHeight( window.innerHeight - 40 );                 
   	  fc.renderAll();
   	     	  
   	  var canvas = document.getElementById("clippingCanvas"), ctx = canvas.getContext('2d');
   	  var copiedCanvas = document.createElement("canvas"), copiedCtx = copiedCanvas.getContext('2d');
   	  var maskCanvas = document.createElement("canvas"), maskCanvasCtx = maskCanvas.getContext('2d');
   	
   	  var pieceWidth = 100, pieceHeight = 100;   	  
   	  
   	  copiedCanvas.width = pieceWidth;
   	  copiedCanvas.height = pieceHeight;
   	  
   	  maskCanvas.width = pieceWidth;
   	  maskCanvas.height = pieceHeight;
   	  
   	  canvas.width = window.innerWidth;
   	  canvas.height = window.innerHeight;   	  
   	  
   	  var fabricImages = [];
   	  
   	  $("#shuffle").click(function(){
   		  
   		  var onChange = function(){
   			  
  		    window.requestAnimationFrame(function(){
  		    	fc.renderAll.bind(fc)();
   			});
   			
   		  };
   		  
   		  $.each(fabricImages, function(i, img){
   			  var left = Math.floor((Math.random() * 800 - 50) + 0); 
   			  var top = Math.floor((Math.random() * 600 - 50) + 0);
   			  img.animate({left: left, top: top}, {onChange: onChange});
   		  });
   		  
   		  return false;
   	  });
   	  
   	  function copyImageChunk(x, y, p){
   		     		  
   		  maskCanvasCtx.clearRect(0, 0, pieceWidth, pieceHeight);
   		  maskCanvasCtx.putImageData(ctx.getImageData(x, y, pieceWidth, pieceHeight), 0, 0);
   		  
   		  copiedCtx.clearRect(0, 0, pieceWidth, pieceHeight);   		  
   		  
   		  copiedCtx.globalCompositeOperation = "source-over";
   		  copiedCtx.drawImage(p, 0, 0, 100, 100);
   		  
   		  copiedCtx.globalCompositeOperation = "source-in";  		  
   		  copiedCtx.drawImage(maskCanvas, 0, 0, 100, 100);
   		  
   		  fabric.Image.fromURL(copiedCanvas.toDataURL("image/png"), function(img) { 
   			  
   			  /*   			  
   			  img.set("borderColor", "rgb(255, 255, 255)");
   			  img.set("scaleX", ".9");
 			  img.set("scaleY", ".9")   			  
   			  */
   			     			  
   			  img.set("hasBorders", false);
   			  img.set("left", x);
   			  img.set("top", y);
   			     			     			  
   			  img.hasControls = false;
   			  img.lockRotation = true;
   			  img.lockScalingX = true; img.lockScalingY = true;   			  
   			  img.originalCoords = [x, y];
   			
   			  fc.add(img);
   			  fabricImages.push(img);   			     			  
   		  });
   		  
   	  }
   	  
   	  function drawImage(image){
   		     		  
   		  var iC = 0, jC = 0;
   		  var pieces = [piece2, piece1, piece2];
   		  
   		  ctx.drawImage(image, 0, 0, 800, 600);
   		  
   		  for(var i = 0; i < 800; i += pieceWidth){
   			  
   			for(var j = 0; j < 600; j += pieceHeight){
   				
   		  		copyImageChunk(i, j, pieces[jC]);   		  		
   		  		jC += 1;
   		  		
   		  		if( jC == 2 ){
   		  			jC = 0;
   		  		}
   			}
   			
   		  }
   		  
   	  }   	  
   	  
   	  function setup(loadedImages, puzzleImage){   		  
   		     		  
   		  var imageHeight = puzzleImage.height, imageWidth = puzzleImage.width;   		   		     		
   		  var targetHeight, targetWidth;   		     		  
   		     		  
   		  if( imageHeight / imageWidth < window.innerHeight / window.innerWidth ){   			  
   			  targetWidth = window.innerWidth;
   			  targetHeight = Math.floor( (targetWidth * imageHeight) / imageWidth );   			  
   		  }else{
   			  targetHeight = window.innerHeight;
   			  targetWidth = Math.floor( (targetHeight * imageWidth) / imageHeight );
   		  }   		  
   		  
   		  var getImg = function(el){
   			  			  return _.find(loadedImages, function(e){return $(e).attr("src") == "puzzle_pieces/" + el;})
   			  			};
   			  			
   		  var cornerLeft = getImg("1.png").width * .7, cornerRight = getImg("9.png").width * .7;
   		  var midLeft = getImg("2.png").width * .7, midRight = getImg("3.png").width * .7;   		  
   		  var middleSide = getImg("4.png").width * .73, cornerBottom = getImg("7.png").width * .73;
   		  
   		  var numWide = 2 + (Math.ceil((targetWidth - (cornerLeft + cornerRight)) / (midLeft + midRight)) * 2);
   		  var cornerLeftHeight = getImg("1.png").width * .92;
   		  var numHeight = Math.ceil((targetHeight - (cornerLeftHeight + cornerBottom)) / middleSide);   		     		     		  
   		     		  
   		  var filledGrid = ["4.png"], piecesGrid = [ ["1.png"] ], lastGrid = ["7.png"];
   		  
   		  for(var j = 1; j < numWide - 1; j++){
   			
   			if(j % 2 == 0){
   				filledGrid.push("6.png");
   				lastGrid.push("12.png");
   				
   				piecesGrid[0].push("3.png");   				
   			}else{
   				filledGrid.push("5.png");
   				lastGrid.push("11.png");
   				
   				piecesGrid[0].push("2.png");   				
   			}
   			
   		  }
   		  
   		  filledGrid.push("10.png");
   		  piecesGrid[0].push("9.png");
   		  lastGrid.push("8.png");
   		
   		  for(var i = 1; i < numHeight; i++){
   			piecesGrid[i] = filledGrid;
   		  }   		     		  
   		     		  
   		  piecesGrid[ numHeight ] = lastGrid;   		  
   		  
   		  ctx.drawImage(puzzleImage, 0, 0, targetWidth, targetHeight);
   		  
   		  var img = null, offsetW = 0, offsetH = 0;
   		  for(var i = 0; i < piecesGrid.length; i++){
   			  
   			  offsetW = 0;   			  
   			  
   			  for(var j = 0; j < piecesGrid[i].length; j++){
   				  
   				  innerOffsetH = 0, innerOffsetW = 0;
   				
   				  img = getImg( piecesGrid[i][j] );
   				     				  
   				  if(i == 0 && j == 1){
   					  innerOffsetW = -4;
  				  }
   				  
   				  if( i > 0 ){
   					  
   					  if( j > 0 && j % 2 == 0 ){
   						innerOffsetH = 0;					
   					  }
   					  
   					  if( j > 0 && j % 2 == 1 ){
   						innerOffsetH = -30;   						
   					  }
   					  
   					  if( j == piecesGrid[i].length - 1 ){
   						innerOffsetH = -29;
   					  }
   				  }
   				  
   				  ctx.drawImage(img, offsetW + innerOffsetW, offsetH + innerOffsetH);
   				     				  
   				  if( i == 0 ){
   				  	offsetW += img.width * .7;
   				  }else if( i < piecesGrid.length - 1 ){
   					  
   					if( j < piecesGrid[i].length - 2 && j % 2 == 0 ){
   						offsetW += img.width * .73;
   					}
   					
   					if( j < piecesGrid[i].length - 2 && j % 2 == 1 ){
   						offsetW += img.width * .61;
   					}   					   					
   					
   					if( j == piecesGrid[i].length - 2 ){
   						offsetW += img.width * .75;
   					}   							
   					
   				  }else if(i == piecesGrid.length - 1){
   					  
  					if( j < piecesGrid[i].length - 2 && j % 2 == 0 ){
  						offsetW += img.width * .71;
       				}   					   					   					  
   					
   					if( j < piecesGrid[i].length - 2 && j % 2 == 1 ){
   						offsetW += img.width * .7;
   					}   					   					
   					
   					if( j == piecesGrid[i].length - 2 ){
   						offsetW += img.width * .7;
   					}   							  					
  					
   				  }   				  
   				  
   			  }
   			  
   			  if( i == 0 ){
   				offsetH += img.height * .92;
   			  }else if(i == piecesGrid.length - 2){
   				offsetH += img.height * .74;
   			  }else{
   				offsetH += img.height * .73;
   			  }
   			  
   		  }
   		  
   		  /*
   		  var drawCanvas = document.createElement("canvas"), drawCanvasCtx = drawCanvas.getContext('2d');   		  
   		  drawCanvas.width = puzzleImage.width;
   		  drawCanvas.height = puzzleImage.height;
   		  drawCanvasCtx.drawImage(puzzleImage, 0, 0);
   		     		  
   		  var puzzleData = drawCanvasCtx.getImageData(offsetX, offsetY, imageWidth, imageHeight);   		  
   		  drawCanvas = document.createElement("canvas");
   		  drawCanvasCtx = drawCanvas.getContext('2d');
   		  
   		  drawCanvas.width = imageWidth;
   		  drawCanvas.height = imageHeight;   		  
   		  drawCanvasCtx.putImageData(puzzleData, 0, 0);
   				
   		  fabric.Image.fromURL(drawCanvas.toDataURL("image/png"), function(img) {
   			fc.add(img);
   		  });
   		  */
   	  }
   	     	  
      var loadedImages = ["1.png", "2.png", "3.png", "4.png", "5.png", 
                          "6.png", "7.png", "8.png", "9.png", "10.png", "11.png", "12.png"];
      
      loadedImages = _.map(loadedImages, function(src){
	    	  var img = new Image();    	  
	    	  img.src = "puzzle_pieces/" + src;
	    	  img.df = $.Deferred();
	    	  
	    	  img.addEventListener("load", function(){img.df.resolve(this);});    	  
	    	  return img;
   	  });    	  
      
      var imageDfs = _.pluck(loadedImages, "df");      
   	  
      var df = $.Deferred();
   	  imageDfs.push(df);   	  
   	  var puzzleImage = new Image();
   	  puzzleImage.src = "beaconhill.jpg";   	
   	  puzzleImage.addEventListener("load", function(){ df.resolve(this); });
   	     	
      $.when.apply($, imageDfs)
      .done(function(){
    	      	      	
        	setup(loadedImages, puzzleImage);
        	
    	  	window.setTimeout(function(){
    	  	  $("#shuffle").click();   
    	  	}, 1000 );
      });
      
    </script>
        
  </body>
 </html>