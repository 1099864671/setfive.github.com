<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title></title>

    <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,700,800' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Lato:400,700,900' rel='stylesheet' type='text/css'>
    
    <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet">
        
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="bootstrap/js/bootstrap.min.js"></script>
    <script src="lodash.min.js"></script>    
    <script src="fabric.min.js"></script>
    
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    
    <style>
      * { 
        margin:0; 
        padding:0; 
      }
      
      html, body {
       width:100%; 
       height:100%; 
      }
      
      canvas { 
        display:block; 
      }
      
      .main-container {
      	padding: 20px;
      	background: #000;     	
      }            
                  
      #shuffle {
      	position: absolute;
      	top: 0px;
      	right: 0px;
      }
    </style>    
  </head>
  <body>
  	
  	<div class="main-container">
  		<canvas id="canvas"></canvas>
  	</div>
  	
  	<div class="container main-container">
  		<div class="col-md-12">
  			
  			<button class="btn btn-primary" id="shuffle">Shuffle</button>  			  			
  	      			
		</div>  	       
    </div>        
    
    <script type="text/javascript">    
      
      var fc = new fabric.Canvas("canvas", {backgroundColor: 'rgb(0, 0, 0)', border: "1px solid white"});
      var fabricImages = [];
      
      fc.on("object:moving", function(el){
    	 var tl = Math.pow(el.target.getLeft() - el.target.originalCoords[0], 2);    	 
    	 var tt = Math.pow((el.target.getTop() - el.target.originalCoords[1]), 2);    	 
    	 
    	 if( Math.sqrt(tl + tt) < 10 ){
    		 el.target.set("left", el.target.originalCoords[0]);
    		 el.target.set("top", el.target.originalCoords[1]);    		 
    		 el.target.set("lockMovementX", true);
    		 el.target.set("lockMovementY", true);
    		 el.target.set("opacity", .6);
    	 }
      });
      
      fc.setWidth( window.innerWidth - 40 );
      fc.setHeight( window.innerHeight - 40 );                 
   	  fc.renderAll();
   	  
   	  function copyImageChunk(ctx, img, x, y){
   		
   	   	  var copiedCanvas = document.createElement("canvas"), copiedCtx = copiedCanvas.getContext('2d');
   	   	  var maskCanvas = document.createElement("canvas"), maskCanvasCtx = maskCanvas.getContext('2d');
   	   	  var w = img.width, h = img.height;
   	   	  
   		  maskCanvas.width = w;
   		  maskCanvas.height = h;

   		  copiedCanvas.width = w;
   		  copiedCanvas.height = h;   		  
   		  
   		  copiedCtx.drawImage(img, 0, 0);
   		  maskCanvasCtx.putImageData( ctx.getImageData(x, y, w, h), 0, 0);
   		  
   		  copiedCtx.globalCompositeOperation = "source-in";  		  
   		  copiedCtx.drawImage(maskCanvas, 0, 0);
   		  
   		  fabric.Image.fromURL(copiedCanvas.toDataURL("image/png"), function(img) { 
   			  
   			  img.set("hasBorders", false);
   			  img.set("left", x);
   			  img.set("top", y);
   			     			     			  
   			  img.hasControls = false;
   			  img.lockRotation = true;
   			  img.lockScalingX = true; img.lockScalingY = true;   			  
   			  img.originalCoords = [x, y];
   			
   			  fc.add(img);
   			  fabricImages.push(img);   			     			  
   		  });   		  
   		  
   	  }
   	  
   	  function getImg(loadedImages, el){   		  
   		  return _.find(loadedImages, function(e){
   			  return $(e).attr("src") == "puzzle_pieces/" + el;
   		  });   		  
   	  }
   	  
   	  function setup(ctx, loadedImages, puzzleImage){   		  
   		     		  
   		  var imageHeight = puzzleImage.height, imageWidth = puzzleImage.width;   		   		     		
   		  var targetHeight, targetWidth;   		     		  
   		     		  
   		  if( imageHeight / imageWidth < window.innerHeight / window.innerWidth ){   			  
   			  targetWidth = window.innerWidth;
   			  targetHeight = Math.floor( (targetWidth * imageHeight) / imageWidth );   			  
   		  }else{
   			  targetHeight = window.innerHeight;
   			  targetWidth = Math.floor( (targetHeight * imageWidth) / imageHeight );
   		  }   		  
   		  
   		  var cornerLeft = getImg(loadedImages, "1.png").width * .7, cornerRight = getImg(loadedImages, "9.png").width * .7;   		  
   		  var midLeft = getImg(loadedImages, "2.png").width * .7, midRight = getImg(loadedImages, "3.png").width * .7;   		  
   		  var middleSide = getImg(loadedImages, "4.png").width * .73, cornerBottom = getImg(loadedImages, "7.png").width * .73;
   		  
   		  var numWide = 2 + (Math.ceil((targetWidth - (cornerLeft + cornerRight)) / (midLeft + midRight)) * 2);
   		  var cornerLeftHeight = getImg(loadedImages, "1.png").width * .92;
   		  var numHeight = Math.ceil((targetHeight - (cornerLeftHeight + cornerBottom)) / middleSide);   		     		     		  
   		     		  
   		  var filledGrid = ["4.png"], piecesGrid = [ ["1.png"] ], lastGrid = ["7.png"];
   		  
   		  for(var j = 1; j < numWide - 1; j++){
   			
   			if(j % 2 == 0){
   				filledGrid.push("6.png");
   				lastGrid.push("12.png");
   				
   				piecesGrid[0].push("3.png");   				
   			}else{
   				filledGrid.push("5.png");
   				lastGrid.push("11.png");
   				
   				piecesGrid[0].push("2.png");   				
   			}
   			
   		  }
   		  
   		  filledGrid.push("10.png");
   		  piecesGrid[0].push("9.png");
   		  lastGrid.push("8.png");
   		
   		  for(var i = 1; i < numHeight; i++){
   			piecesGrid[i] = filledGrid;
   		  }   		     		  
   		     		  
   		  piecesGrid[ numHeight ] = lastGrid;   		  
   		  
   		  ctx.drawImage(puzzleImage, 0, 0, targetWidth, targetHeight);
   		  
   		  return piecesGrid;   		     		   		  
   	  }
   	  
   	  function iterativeCopy(res){
   		  
   		  if( res.i >= res.piecesGrid.length && res.j == 0 ){
   			  return false;
   		  }
   		     		  
   		  var piecesGrid = res.piecesGrid;
   		  var img = null;
   		  
		  innerOffsetH = 0, innerOffsetW = 0;
 				
		  img = getImg( res.loadedImages, piecesGrid[res.i][res.j] );
		     				  
		  if(res.i == 0 && res.j == 1){
			  innerOffsetW = -4;
		  }
		  
		  if( res.i > 0 ){			  
			  if( res.j > 0 && res.j % 2 == 0 ){
				innerOffsetH = 0;					
			  }
			  
			  if( res.j > 0 && res.j % 2 == 1 ){
				innerOffsetH = -30;   						
			  }
			  
			  if( res.j == piecesGrid[res.i].length - 1 ){
				innerOffsetH = -29;
			  }
		  }
		     				  
		  copyImageChunk(res.ctx, img, res.offsetW + innerOffsetW, res.offsetH + innerOffsetH);
		     				  
		  if( res.i == 0 ){
			  res.offsetW += img.width * .7;
		  }else if( res.i < piecesGrid.length - 1 ){
			  
			if( res.j < piecesGrid[res.i].length - 2 && res.j % 2 == 0 ){
				res.offsetW += img.width * .73;
			}
			
			if( res.j < piecesGrid[res.i].length - 2 && res.j % 2 == 1 ){
				res.offsetW += img.width * .61;
			}   					   					
			
			if( res.j == piecesGrid[res.i].length - 2 ){
				res.offsetW += img.width * .75;
			}   							
			
		  }else if(res.i == res.piecesGrid.length - 1){
			  
			if( res.j < res.piecesGrid[res.i].length - 2 && res.j % 2 == 0 ){
				res.offsetW += img.width * .71;
			}   					   					   					  
			
			if( res.j < res.piecesGrid[res.i].length - 2 && res.j % 2 == 1 ){
				res.offsetW += img.width * .7;
			}   					   					
			
			if( res.j == res.piecesGrid[res.i].length - 2 ){
				res.offsetW += img.width * .7;
			}
			
		  }
   		  
		  res.j += 1;
		  
   		  if( res.j == piecesGrid[res.i].length ){
   			  
   			  res.i += 1;
   			  res.j = 0;     			
   			  res.offsetW = 0;
   			
   			  if( res.i == 0 ){
   				res.offsetH += img.height * .92;
   			  }else if(res.i == piecesGrid.length - 2){
   				res.offsetH += img.height * .74;
   			  }else{
   				res.offsetH += img.height * .73;
   			  }   			  
   		  }   		  
   		  
   		  window.requestAnimationFrame(function(){   			  
   			  iterativeCopy(res); 
   		  });
   	  }
   	  
   	  function bootstrap(){
	      var loadedImages = 
	    	  _(["1.png", "2.png", "3.png", "4.png", "5.png", "6.png", 
	    	      "7.png", "8.png", "9.png", "10.png", "11.png", "12.png"])
	     	   .map(function(src){
		    	  var img = new Image();    	  
		    	  img.src = "puzzle_pieces/" + src;
		    	  img.df = $.Deferred();
		    	  
		    	  img.addEventListener("load", function(){img.df.resolve(this);});    	  
		    	  return img;
	   	  }).value();      
	      
	      var imageDfs = _.pluck(loadedImages, "df");      
	   	  
	      var df = $.Deferred();
	   	  imageDfs.push(df);
	   	  
	   	  var puzzleImage = new Image();
	   	  puzzleImage.src = "beaconhill.jpg";   	
	   	  puzzleImage.addEventListener("load", function(){ df.resolve(this); });
	   	  
	   	  var canvas = document.createElement("canvas"), ctx = canvas.getContext('2d');   	     	     	  
	     	
	   	  canvas.width = window.innerWidth - 40;
	   	  canvas.height = window.innerHeight - 40;   	     	     	  
	   	  
	      $.when.apply($, imageDfs).done(function(){
	    	  var res = {ctx: ctx, offsetW: 0, offsetH: 0, i: 0, j: 0};
	    	  
	    	  res.loadedImages = loadedImages;
	    	  res.piecesGrid = setup(ctx, loadedImages, puzzleImage);	    	  
	    	  
	    	  window.requestAnimationFrame(function(){ iterativeCopy(res); });	    	  
	      });   		  
   	  }
   	  
   	  $(document).ready(function(){
   		  
   		  bootstrap();
   		
	   	  $("#shuffle").click(function(){
	   		  
	   		  var onChange = function(){   			  
	  		    window.requestAnimationFrame(function(){
	  		    	fc.renderAll.bind(fc)();
	   			});   			
	   		  };
	   		  
	   		  $.each(fabricImages, function(i, img){
	   			  var left = Math.floor((Math.random() * 800 - 50) + 0); 
	   			  var top = Math.floor((Math.random() * 600 - 50) + 0);
	   			  img.animate({left: left, top: top}, {onChange: onChange});
	   		  });
	   		  
	   		  return false;
	   	  });
      
   	  });
   	  
    </script>
        
  </body>
 </html>